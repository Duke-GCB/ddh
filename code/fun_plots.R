library(tidyverse)
library(cowplot)
library(ggdist)
library(scico)
library(plotly)
library(gganatogram)
#library(extrafont)

#extrafont::loadfonts()

make_cellbins <- function(cellbins_data = achilles, expression_data = expression_names, gene_symbol) {
  plot_complete <- cellbins_data %>% #plot setup
    select(X1, any_of(gene_symbol)) %>%
    left_join(expression_data, by = "X1") %>%
    select(-X1) %>%
    pivot_longer(cols = where(is.numeric), names_to = "gene_symbol", values_to = "dep_score") %>% 
    group_by(gene_symbol) %>% 
    arrange(dep_score) %>% 
    mutate(med = median(dep_score, na.rm = T)) %>% 
    ungroup() %>% 
    filter(!is.na(dep_score)) %>% 
    ggplot() +
    geom_rect(xmin = -1, xmax = 1, ymin = -Inf, ymax = Inf,
              fill = "grey92") +
    # geom_vline(xintercept = 1, color = "gray55") +
    #geom_vline(xintercept = 0, color = "gray80") +
    geom_vline(xintercept = 0, color = "white", linetype = "dashed") +
    # geom_vline(xintercept = -1, color = "gray55") +
    geom_linerange(aes(xmin = -Inf, xmax = med, 
                       y = fct_reorder(gene_symbol, med), 
                       #color = fct_reorder(gene_symbol, med)),
                       color = med < -1),
                   linetype = "dotted",
                   size = .2) +
    stat_halfeye(aes(x = dep_score, y = fct_reorder(gene_symbol, med),
                     #color = fct_reorder(gene_symbol, med), 
                     fill = stat(abs(x) > 1),
                     point_fill = after_scale(fill)),
                 .width = c(.025, .975),
                 color = "black",
                 shape = 21,
                 stroke = .7,
                 point_size = 2) +
    #geom_vline(xintercept = 0, alpha = .2) +
    labs(x = "Dependency Score (binned)", y = NULL, color = "Query \nGene", fill = "Query \nGene") +
    scale_y_discrete(expand = c(.03, .03)) +
    #scale_color_scico_d(palette = "lapaz", guide = "legend", end = .8) +
    scale_color_manual(values = c("grey70", "#0fb78e")) +
    scale_fill_manual(values = c("grey70", "#0fb78e")) +
    guides(
      color = guide_legend(size = 1, reverse = T),
      fill = guide_legend(size = 1, reverse = T)
    ) +
    theme_cowplot(font_size = 16) +
    theme(#text = element_text(family = "Nunito Sans"),
          legend.position = "none", 
          axis.line.y = element_blank(), 
          axis.ticks.y = element_blank(), 
          axis.text.y = element_text(size = 17), ) +
    NULL
    return(plot_complete)
}

#figure legend
plot_cellbins_title <- "Kernel density estimate."
plot_cellbins_legend <- "Computed density curves of dependency scores. Dependency scores across all cell lines for queried genes, revealing overall influence of a gene on cellular fitness. The interval indicates the 95% quantile of the data, the dot indicates the median dependency score."

make_celldeps <- function(celldeps_data = achilles, expression_data = expression_names, gene_symbol, mean) {
  plot_complete <- celldeps_data %>% #plot setup
    select(X1, any_of(gene_symbol)) %>%
    left_join(expression_data, by = "X1") %>%
    select(-X1) %>%
    pivot_longer(cols = where(is.numeric), names_to = "gene_symbol", values_to = "dep_score") %>% 
    group_by(gene_symbol) %>% 
    arrange(dep_score) %>% 
    mutate(
      rank = 1:n(),
      med = median(dep_score, na.rm = T)
    ) %>% 
    ungroup() %>% 
    ggplot(aes(x = rank, 
               y = dep_score, 
               text = paste0("Cell Line: ", cell_line), 
               color = fct_reorder(gene_symbol, med),
               fill = fct_reorder(gene_symbol, med)
      )) +
      geom_hline(yintercept = mean) +
      geom_hline(yintercept = 1, color = "lightgray", linetype = "dashed") +
      geom_hline(yintercept = -1, color = "lightgray", linetype = "dashed") +
      geom_hline(yintercept = 0) +
      geom_point(size = 1, stroke = .1, alpha = 0.4) + 
      scale_x_discrete(expand = expansion(mult = 0.02), na.translate = FALSE) +
      scale_color_scico_d(palette = "lapaz", guide = "legend", end = .8) +
      scale_fill_scico_d(palette = "lapaz", guide = "legend", end = .8) +
      guides(
        color = guide_legend(reverse = T, override.aes = list(size = 5)),
        fill = guide_legend(reverse = T, override.aes = list(size = 5))
      ) +
      labs(x = "Rank", y = "Dependency Score", color = "Query \nGene", fill = "Query \nGene") +
      theme_cowplot(font_size = 16) +
      theme(#text = element_text(family = "Nunito Sans"), 
            axis.text.x=element_blank(), 
            axis.title.x=element_blank(), 
            axis.ticks.x=element_blank(), 
            axis.line.x = element_blank()) + # axis.title.x=element_blank()
      NULL}

#figure legend
plot_celldeps_title <- "Cell Line Dependency Curve."
plot_celldeps_legend <- "Each point shows the ranked dependency score ordered from low to high scores. Cells with dependency scores less than -1 indicate a cell that the query gene is essential within. Cells with dependency scores close to 0 show no changes in fitness when the query gene is knocked out. Cells with dependency scores greater than 1 have a gain in fitness when the query gene is knocked-out."

# make cell anatogram
make_cellanatogram <- function(cellanatogram_data = subcell, gene_symbol) {
  plot_complete <- cellanatogram_data %>% 
    filter_all(any_vars(gene_name %in% gene_symbol)) %>% 
    filter(!is.na(type)) %>% 
    select(-value) %>% 
    add_count(main_location) %>% 
    mutate(value = as_factor(n)) %>% 
    gganatogram(outline = T, fillOutline='grey95', organism="cell", fill = "value") +
    theme_void() +  
    coord_fixed() +
    scale_fill_viridis_d() +
    labs(fill = "Count") +
    #theme(text = element_text(family = "Nunito Sans")) +
    NULL
  
  if(length(gene_symbol) == 1){
    plot_complete  <- plot_complete +
      guides(fill = "none")
  } else {
    plot_complete
  }
  return(plot_complete)
}

# make lineage plot
make_lineage <- function(celldeps_data = achilles, expression_data = expression_names, gene_symbol) {
  data_full <- celldeps_data %>% #plot setup
    select(X1, any_of(gene_symbol)) %>%
    left_join(expression_data, by = "X1") %>%
    select(-X1) %>%
    pivot_longer(cols = where(is.numeric), names_to = "gene_symbol", values_to = "dep_score") %>%
    dplyr::mutate_at("lineage", function(str) {
      str <- str_replace_all(str, "\\_", " ")
      str <- str_to_title(str)
      return(str)
    }) %>% 
    drop_na(lineage) %>% 
    drop_na(dep_score) %>% 
    group_by(lineage) %>% 
    mutate(mean = mean(dep_score)) %>% 
    ungroup() %>% 
    mutate(lineage = fct_reorder(lineage, -mean))
  
  data_mean <- data_full %>% 
    group_by(lineage) %>% 
    summarize(dep_score = mean(dep_score))
  
  plot_complete <- 
    ggplot() +
      geom_vline(xintercept = 0) +
      geom_linerange(data = data_mean,
                     aes(xmin = -Inf, xmax = dep_score, y = lineage),
                     color = "grey60",
                     linetype = "dotted") +
      stat_interval(data = data_full,
                    aes(x = dep_score, y = lineage),
                    orientation = "horizontal",
                   .width = c(.05, .5, .95)
      ) +
      geom_point(data = data_mean, aes(x = dep_score, y = lineage), color = "black") +
      scale_color_manual(values = c("#aae3dd", "#19acb5", "#036d77"), labels = c("95%", "50%", "5%"), name = "") +
      guides(color = guide_legend(reverse = TRUE)) +
      labs(x = "Dependency Score", y = NULL, title = "Cell Lineage:") +
      theme_cowplot(font_size = 16) +
      theme(#text = element_text(family = "Nunito Sans"), 
            legend.position = "bottom", 
            axis.line.y = element_blank(), 
            axis.ticks.y = element_blank(), 
            plot.title = element_text(size = 14), 
            plot.title.position = "plot")
  return(plot_complete)
}

#figure legend
plot_celllin_title <- "Cell Line Lineage Dependencies"
plot_celllin_legend <- "Each point shows the mean dependency score for a given cell lineage and the intervals show the 5% quantiles, the interquartile ranges, and the 95% quantiles."

# make sublineage plot
make_sublineage <- function(celldeps_data = achilles, expression_data = expression_names, gene_symbol) {
  data_full <- celldeps_data %>% #plot setup
    select(X1, any_of(gene_symbol)) %>%
    left_join(expression_data, by = "X1") %>%
    select(-X1) %>%
    pivot_longer(cols = where(is.numeric), names_to = "gene_symbol", values_to = "dep_score") %>% 
    dplyr::mutate_at("lineage_subtype", function(str) {
      str <- str_replace_all(str, "\\_", " ")
      str <- if_else(str_detect(str, "^[:lower:]"), str_to_title(str), str)
      return(str)
    })  %>% 
    drop_na(lineage_subtype) %>% 
    drop_na(dep_score) %>% 
    group_by(lineage_subtype) %>% 
    mutate(mean = mean(dep_score)) %>% 
    ungroup() %>% 
    mutate(lineage_subtype = fct_reorder(lineage_subtype, -mean))
  
  data_mean <- data_full %>% 
    group_by(lineage_subtype) %>% 
    summarize(dep_score = mean(dep_score))
  
  plot_complete <- 
    ggplot() +
    geom_vline(xintercept = 0) +
    geom_linerange(data = data_mean,
                   aes(xmin = -Inf, xmax = dep_score, y = lineage_subtype),
                   color = "grey60",
                   linetype = "dotted") +
    stat_interval(data = data_full,
                  aes(x = dep_score, y = lineage_subtype),
                  orientation = "horizontal",
                  .width = c(.05, .5, .95)
    ) +
    geom_point(data = data_mean, aes(x = dep_score, y = lineage_subtype), color = "black") +
    scale_color_manual(values = c("#aae3dd", "#19acb5", "#036d77"), labels = c("95%", "50%", "5%"), name = "") +
    guides(color = guide_legend(reverse = TRUE)) +
    labs(x = "Dependency Score", y = NULL, title = "Cell Sublineage:") +
    theme_cowplot(font_size = 16) +
    theme(#text = element_text(family = "Nunito Sans"), 
          legend.position = "bottom", 
          axis.line.y = element_blank(), 
          axis.ticks.y = element_blank(), 
          plot.title = element_text(size = 14), plot.title.position = "plot")
  return(plot_complete)
}

#figure legend
plot_cellsublin_title <- "Cell Line Sub-Lineage Dependencies"
plot_cellsublin_legend <- "Each point shows the mean dependency score for a given cell sublineage and the intervals show the 5% quantiles, the interquartile ranges, and the 95% quantiles."

make_cellexpression <- function(expression_data = expression, expression_join = expression_names, gene_symbol, mean = mean_virtual_expression, upper_limit = expression_upper, lower_limit = expression_lower) {
  plot_complete <- expression_data %>% #plot setup
    dplyr::select(where(is.character), any_of(gene_symbol)) %>% 
    dplyr::left_join(expression_join, by = "X1") %>%
    dplyr::select(-X1) %>%
    dplyr::select(cell_line, lineage, lineage_subtype, everything()) %>% 
    dplyr::mutate_if(is.numeric, ~round(., digits = 3)) %>% 
    pivot_longer(cols = where(is.numeric), names_to = "gene_symbol", values_to = "cell_exp") %>% 
    ggplot(aes(x = fct_reorder(cell_line, cell_exp, .fun = max, .desc = FALSE), 
               y = cell_exp, 
               text = paste0("Cell Line: ", cell_line), 
               color = fct_reorder(gene_symbol, cell_exp, .fun = max, .desc = TRUE)
    )) +
    geom_point(alpha = 0.4) + #color = "#02224C"
    labs(x = "Cell Lines", y = "Gene Expression", color = "Query \nGene") +
    geom_hline(yintercept = mean) +
    geom_hline(yintercept = upper_limit, color = "lightgray") + #3SD
    geom_hline(yintercept = 0, color = "lightgray") + #3SD is below zero
    scale_color_viridis(discrete = TRUE, guide = "legend") +
    scale_x_discrete(expand = expansion(mult = 0.02), na.translate = FALSE) +
    theme_cowplot() +
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + # axis.title.x=element_blank()
    NULL
  
  if(length(gene_symbol) == 1){
    plot_complete  <- plot_complete +
      guides(color = "none")
  } else {
    plot_complete
  }
  return(plot_complete)
}

#figure legend
plot_cellexp_title <- "Gene Expression in CCLE Cell Lines."
plot_cellexp_legend <- paste0("Each point shows the ranked expression value for a given cell line. Black line indicates resampled mean expression value (", round(mean_virtual_expression, 2), "). Gray line indicates 3 standard deviations away from the resampled mean (", round(expression_upper, 2), ").")
