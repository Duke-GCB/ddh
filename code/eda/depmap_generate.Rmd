---
title: "ddh.com"
output:
  pdf_document:
    toc: TRUE
---
Integrate gene + drug data

##Load libraries
```{r load_block, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(here)
library(janitor)
library(feather)
library(corrr)
library(purrr)
library(beepr) #long analysis; get some coffee, and comeback when ready

#clear environment
#rm(list=ls()) 

#how long?
start_time <- Sys.time()
```

##import
```{r import}
#read current release information to set parameters for download
source(here::here("code", "current_release.R"))

##BROAD
achilles <- read_csv(achilles_url, col_names = TRUE) %>%
  `colnames<-`(str_remove_all(names(.), "\\s\\(\\d+\\)"))
save(achilles, file = here::here("data", paste0(release, "_achilles.RData")))

achilles_long <- achilles %>% 
  pivot_longer(-X1, names_to = "gene", values_to = "dep_score")

#EXPRESSION(BROAD)
expression <- read_csv(ccle_url, col_names = TRUE) %>% 
  `colnames<-`(str_remove_all(names(.), "\\s\\(\\d+\\)"))
save(expression, file = here::here("data", paste0(release, "_expression.RData")))

expression_id <- read_csv(cclemeta_url, col_names = TRUE) %>% 
  clean_names
save(expression_id, file = here::here("data", paste0(release, "_expression_id.RData")))

expression_join <- expression_id %>% 
  rename(X1 = dep_map_id) %>% 
  select(X1, stripped_cell_line_name, lineage)
save(expression_join, file = here::here("data", paste0(release, "_expression_join.RData")))

expression_long <- expression %>% 
  filter(expression$X1 %in% achilles$X1 == TRUE) %>% #matches cells
  gather("gene", "gene_expression", -X1) %>% 
  arrange(desc(gene_expression))

no_expression <- expression_long %>% 
  filter(gene_expression == 0) %>% 
  unite(X1, gene, col = "match", sep = "-", remove = TRUE) %>% 
  pull(match) %>% 
  as_tibble()

achilles_no0 <- achilles_long %>% 
  unite(X1, gene, col = "match", sep = "-", remove = FALSE) %>% 
  filter(match %in% no_expression == FALSE) %>% 
  select(-match) %>%
  spread(gene, dep_score) %>% 
  as_tibble()

na_cutoff <- na_cutoff

toomanyNAs <- achilles_no0 %>% 
  summarise_all(list(~sum(is.na(.)))) %>% 
  gather(gene, NAs) %>% 
  arrange(desc(NAs)) %>% 
  filter(NAs > na_cutoff) %>% 
  pull(gene)

achilles_clean <- achilles_no0 %>% 
  select(-one_of(toomanyNAs))

```

#add drug data
These are log-fold change collapsed replicates with outliers and controls removed
```{r}
prism <- read_csv(prism_url, col_names = TRUE) %>% 
  clean_names()

prism_meta <- read_csv(prismmeta_url, col_names = TRUE) %>% 
  clean_names() %>% 
  mutate(clean_drug = make_clean_names(column_name))

prism_long <- prism %>% 
  #slice(1:10) %>% 
  pivot_longer(cols = -x1, names_to = "drug", values_to = "log2fc") %>% 
  left_join(prism_meta, by = c("drug" = "clean_drug")) %>% 
  select(x1, name, drug, log2fc) %>% 
  unite(col = "drug_united", name:drug, na.rm = TRUE, remove = TRUE)

#EDA
ggplot(prism_meta) +
  geom_histogram(aes(x = dose))

ggplot(prism_long) +
  geom_histogram(aes(x = log2fc))

```

#get log2FC values of achilles
```{r}
achilles_log_url <- "https://ndownloader.figshare.com/files/20234319"
achilles_log2fc_raw <- read_csv(achilles_log_url, col_names = TRUE)
achilles_guide_map_url <- "https://ndownloader.figshare.com/files/20234082"
achilles_guide_map <- read_csv(achilles_guide_map_url, col_names = TRUE)
achilles_rep_map_url <- "https://ndownloader.figshare.com/files/20234331"
achilles_rep_map <- read_csv(achilles_rep_map_url, col_names = TRUE) #%>% 
  #mutate(replicate_ID_clean = make_clean_names(replicate_ID))

achilles_guide_map$gene <- str_remove_all(achilles_guide_map$gene, "\\s\\(\\d+\\)")

achilles_log2fc <- achilles_guide_map %>% 
  left_join(achilles_log2fc_raw, by = c("sgrna" = "X1")) #%>% 
  #select(1:100)

#colnames <- colnames(achilles_log2fc)
achilles_log2fc_long <- achilles_log2fc %>% 
  pivot_longer(cols = "143B-311Cas9_RepA_p6_batch3":"BT549-311cas9 Rep A p5_batch2", names_to = "cell_line", values_to = "log2fc")

achilles_log2fc_long <- achilles_log2fc_long %>% 
  left_join(achilles_rep_map, by = c( "cell_line" = "replicate_ID")) %>% 
  select(DepMap_ID, gene, log2fc)
  
achilles_log2fc_long_mean <- achilles_log2fc_long %>% 
  group_by(DepMap_ID, gene) %>% 
  summarize(meanlog2fc = mean(log2fc), 
            sdlog2fc = sd(log2fc)) %>% 
  ungroup()

ggplot(achilles_log2fc_long_mean) +
  geom_histogram(aes(meanlog2fc))
```
#combine and pivot_wider
```{r}
combined <- achilles_log2fc_long_mean %>% 
  select(x1 = DepMap_ID, drug_united = gene, log2fc = meanlog2fc) %>% 
  bind_rows(prism_long) %>% 
  rename(DepMap_ID = x1, treatment = drug_united) %>% 
  pivot_wider(names_from = treatment, values_from = log2fc)
```


#Combined CORRELATION MATRIX
```{r}
combined_cor <- combined %>%
  select(-DepMap_ID) %>% 
  correlate()
#saveRDS(combined_cor, file = here::here("data", paste0(release, "_combined_cor.Rds")))

```

#EDA
```{r}
fav_gene <- "TSC1"

combined_cor %>% 
  focus(!!fav_gene) %>% 
  arrange(desc(.[[2]]))

drugs_top <- combined_cor %>% 
  select(contains("rowname") | contains("_brd")) %>% 
  pivot_longer(cols = -rowname, names_to = "drugs", values_to = "r2") %>% 
  arrange(desc(r2))

drug_gene <- drugs_top %>% 
  #sample_n(100000) %>% 
  filter(str_detect(rowname, "_brd", negate = TRUE), 
         r2 > 0.5) %>% 
  separate(drugs, into = c("drug_name", "broad_id"), sep = "_", remove = FALSE, extra = "merge") %>% 
  left_join(prism_meta, by = c("drug_name" = "name")) %>% 
  mutate(known = if_else(str_detect(target, rowname), TRUE, FALSE)) %>% #directly known?
  select(rowname, drug_name, r2, moa, target, known, disease_area, indication, broad_id.x, drugs)

#write_csv(drug_gene, path = here::here("results", "drug_gene.csv"))

```

#check for positive controls
```{r}
drug_gene %>% 
  filter(!is.na(known)) %>% 
  group_by(drug_name) %>% 
  summarize(match = sum(known)) %>% 
  count(match, sort = TRUE)

#61 positive matches "controls"

#another way is to look to see if genes in functional pathways are correlated with drugs

```

#how long?
```{r}
end_time <- Sys.time()
time_taken <- round(as.duration(start_time %--% end_time)/dminutes(1), digits = 1)
print(time_taken)
```
Approximate time to run was `r time_taken` minutes.

#print Session information for provenance and reproducibility
```{r}
utils:::print.sessionInfo(sessionInfo()[-8]) 
#You can remove an item from sessionInfo(), which is a list with a class attribute, by printing the resulting object omitting one of the list items (omitted list of packages installed, but not loaded)

```
#stamp
```{r}
lubridate::stamp("Data updated December 31, 1979")(now())
```

#beep
```{r}
beep(sound = 8) #because mario is awesome
```



