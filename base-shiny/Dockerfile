FROM rocker/shiny-verse:4.0.0
LABEL maintainer="Dan Leehr <dan.leehr@duke.edu>"

# Install texlive-xetex for PDF generation
RUN apt-get update && apt-get install -y texlive-xetex

RUN install2.r --repos http://archive.linux.duke.edu/cran/ --deps TRUE \
 ggplot2 \
 here \
 corrr  \
 lubridate \
 plotly \
 networkD3 \
 feather \
 tidygraph \
 cowplot \
 digest \
 patchwork \
 viridis \
 pander \
 DT \
 ggraph \
 future \
 shinyWidgets \
 promises

RUN Rscript -e 'devtools::install_github("jespermaag/gganatogram")'

COPY ./shiny-server.conf /etc/shiny-server/shiny-server.conf
RUN chown -R shiny /var/lib/shiny-server/

# OpenShift gives a random uid for the user and some programs try to find a username from the /etc/passwd.
# Let user to fix it, but obviously this shouldn't be run outside OpenShift
RUN chmod ug+rw /etc/passwd
# COPY ./fix-username.sh /fix-username.sh
COPY ./shiny-server.sh /usr/bin/shiny-server.sh
RUN chmod a+rx /usr/bin/shiny-server.sh

# Make sure the directory for individual app logs exists and is usable
RUN chmod -R a+rwX /var/log/shiny-server
RUN chmod -R a+rwX /var/lib/shiny-server

### Setup user for build execution and application runtime
ENV APP_ROOT=/opt/app-root
ENV PATH=${APP_ROOT}/bin:${PATH} HOME=${APP_ROOT}
COPY bin/ ${APP_ROOT}/bin/
RUN chmod -R u+x ${APP_ROOT}/bin && \
    chgrp -R 0 ${APP_ROOT} && \
    chmod -R g=u ${APP_ROOT} /etc/passwd
